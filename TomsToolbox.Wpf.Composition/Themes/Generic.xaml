<ResourceDictionary
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008" mc:Ignorable="d"
  xmlns:toms="urn:TomsToolbox"
  xmlns:local="clr-namespace:TomsToolbox.Wpf.Composition"
  xmlns:styles="urn:TomsToolbox.Wpf.Styles">

  <ControlTemplate x:Key="MenuGroupItemTemplate" TargetType="{x:Type GroupItem}">
    <StackPanel>
      <Separator Style="{DynamicResource {x:Static MenuItem.SeparatorStyleKey}}" />
      <ItemsPresenter />
    </StackPanel>
  </ControlTemplate>

  <ControlTemplate x:Key="FirstMenuGroupItemTemplate" TargetType="{x:Type GroupItem}">
    <ItemsPresenter />
  </ControlTemplate>

  <GroupStyle x:Key="MenuGroupStyle">
    <GroupStyle.ContainerStyle>
      <Style TargetType="GroupItem">
        <Setter Property="Template" Value="{StaticResource MenuGroupItemTemplate}" />
        <Style.Triggers>
          <DataTrigger Binding="{Binding RelativeSource={RelativeSource PreviousData}}" Value="{x:Null}">
            <Setter Property="Template" Value="{StaticResource FirstMenuGroupItemTemplate}" />
          </DataTrigger>
        </Style.Triggers>
      </Style>
    </GroupStyle.ContainerStyle>
  </GroupStyle>

  <Style x:Key="CompositeMenuItemStyle" TargetType="{x:Type MenuItem}">
    <Setter Property="Header" Value="{Binding Header}" />
    <Setter Property="Icon" Value="{Binding Icon, Converter={x:Static toms:ImageSourceToImageConverter.Default}}" />
    <Setter Property="ToolTip" Value="{Binding Description}" />
    <Setter Property="IsCheckable" Value="{Binding IsCheckable}" />
    <Setter Property="toms:StyleBindings.GroupStyle" Value="{StaticResource MenuGroupStyle}" />
    <Setter Property="toms:StyleBindings.GroupDescriptions">
      <Setter.Value>
        <toms:GroupDescriptionCollection>
          <PropertyGroupDescription PropertyName="GroupName" />
        </toms:GroupDescriptionCollection>
      </Setter.Value>
    </Setter>
    <Setter Property="toms:StyleBindings.Behaviors">
      <Setter.Value>
        <toms:BehaviorCollection>
          <local:ItemsControlCompositionBehavior RegionIdBinding="{Binding SubRegionId}" />
        </toms:BehaviorCollection>
      </Setter.Value>
    </Setter>
    <Style.Triggers>
      <DataTrigger Binding="{Binding IsCheckable}" Value="True">
        <Setter Property="IsChecked" Value="{Binding IsChecked}" />
      </DataTrigger>
      <Trigger Property="Role" Value="SubmenuItem">
        <Setter Property="Command" Value="{Binding Command}" />
      </Trigger>
      <Trigger Property="Role" Value="TopLevelItem">
        <Setter Property="Command" Value="{Binding Command}" />
      </Trigger>
    </Style.Triggers>
  </Style>

  <Style TargetType="{x:Type local:CompositeContextMenu}" BasedOn="{StaticResource {x:Type ContextMenu}}">
    <Setter Property="toms:StyleBindings.GroupStyle" Value="{StaticResource MenuGroupStyle}" />
    <Setter Property="toms:StyleBindings.GroupDescriptions">
      <Setter.Value>
        <toms:GroupDescriptionCollection>
          <PropertyGroupDescription PropertyName="GroupName" />
        </toms:GroupDescriptionCollection>
      </Setter.Value>
    </Setter>
    <Setter Property="ItemContainerStyle" Value="{StaticResource CompositeMenuItemStyle}" />
  </Style>

  <Style x:Key="{x:Static toms:ResourceKeys.CompositeMenuStyle}" TargetType="{x:Type Menu}">
    <Setter Property="ItemContainerStyle" Value="{StaticResource CompositeMenuItemStyle}" />
  </Style>

  <ControlTemplate x:Key="MenuGroupItemTemplate" TargetType="{x:Type GroupItem}">
    <StackPanel>
      <Separator Style="{DynamicResource {x:Static styles:ResourceKeys.MenuItemSeparatorStyle}}" />
      <ItemsPresenter />
    </StackPanel>
  </ControlTemplate>

  <ControlTemplate x:Key="FirstMenuGroupItemTemplate" TargetType="{x:Type GroupItem}">
    <ItemsPresenter />
  </ControlTemplate>

  <GroupStyle x:Key="MenuGroupStyle">
    <GroupStyle.ContainerStyle>
      <Style TargetType="GroupItem">
        <Setter Property="Template" Value="{StaticResource MenuGroupItemTemplate}" />
        <Style.Triggers>
          <DataTrigger Binding="{Binding RelativeSource={RelativeSource PreviousData}}" Value="{x:Null}">
            <Setter Property="Template" Value="{StaticResource FirstMenuGroupItemTemplate}" />
          </DataTrigger>
        </Style.Triggers>
      </Style>
    </GroupStyle.ContainerStyle>
  </GroupStyle>

  <Style x:Key="CompositeMenuItemStyle" TargetType="{x:Type MenuItem}" BasedOn="{StaticResource {x:Type MenuItem}}">
    <Setter Property="Header" Value="{Binding Header}" />
    <Setter Property="Icon" Value="{Binding Icon, Converter={x:Static toms:ImageSourceToImageConverter.Default}}" />
    <Setter Property="ToolTip" Value="{Binding Description}" />
    <Setter Property="IsCheckable" Value="{Binding IsCheckable}" />
    <Setter Property="toms:StyleBindings.GroupStyle" Value="{StaticResource MenuGroupStyle}" />
    <Setter Property="toms:StyleBindings.GroupDescriptions">
      <Setter.Value>
        <toms:GroupDescriptionCollection>
          <PropertyGroupDescription PropertyName="GroupName" />
        </toms:GroupDescriptionCollection>
      </Setter.Value>
    </Setter>
    <Setter Property="toms:StyleBindings.Behaviors">
      <Setter.Value>
        <toms:BehaviorCollection>
          <local:ItemsControlCompositionBehavior RegionIdBinding="{Binding SubRegionId}" />
        </toms:BehaviorCollection>
      </Setter.Value>
    </Setter>
    <Style.Triggers>
      <DataTrigger Binding="{Binding IsCheckable}" Value="True">
        <Setter Property="IsChecked" Value="{Binding IsChecked}" />
      </DataTrigger>
      <Trigger Property="Role" Value="SubmenuItem">
        <Setter Property="Command" Value="{Binding Command}" />
      </Trigger>
      <Trigger Property="Role" Value="TopLevelItem">
        <Setter Property="Command" Value="{Binding Command}" />
      </Trigger>
    </Style.Triggers>
  </Style>

  <Style x:Key="{x:Static local:ResourceKeys.CompositeContextMenuStyle}" TargetType="{x:Type ContextMenu}" BasedOn="{StaticResource {x:Type ContextMenu}}">
    <Setter Property="toms:StyleBindings.GroupStyle" Value="{StaticResource MenuGroupStyle}" />
    <Setter Property="toms:StyleBindings.GroupDescriptions">
      <Setter.Value>
        <toms:GroupDescriptionCollection>
          <PropertyGroupDescription PropertyName="GroupName" />
        </toms:GroupDescriptionCollection>
      </Setter.Value>
    </Setter>
    <Setter Property="ItemContainerStyle" Value="{StaticResource CompositeMenuItemStyle}" />
  </Style>

</ResourceDictionary>